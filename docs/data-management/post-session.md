# Post-session retrieval and BIDS

## Within 48h after the FIRST session

!!! danger "Anatomical images must be screened for incidental findings within 48h after the first session"

    - [ ] Send the T1-weighted and T2-weighted scan to {{ secrets.people.medical_contact | default("███") }} for screening and incidental findings.
    - [ ] Indicate on [our recruits spreadsheet]({{ secrets.data.recruits_url | default("/redacted.html") }}) that the participant's first session has been submitted for screening.
    - [ ] Wait for response from {{ secrets.people.medical_contact | default("███") }} and note down the result of the screening in our [our recruits spreadsheet]({{ secrets.data.recruits_url | default("/redacted.html") }}).

To do so, you'll need to first [download the data from PACS](#download-the-data-from-the-pacs-with-pacsman-only-authorized-users) and then [convert the data into BIDS](#convert-imaging-data-to-bids-with-heudiconv).

!!! warning "What to do when there are incidental findings"

    - [ ] Discuss with {{ secrets.people.medical_contact | default("███") }} how to proceed with the participant.
    - [ ] Exclude the participant from the study if {{ secrets.people.medical_contact | default("███") }} evaluates they don't meet the participation (inclusion and exclusion) criteria.

## Within one week after the completed session

### Download the data from the PACS with *PACSMAN* (only authorized users)

- [ ] Log-in into the *PACSMAN* computer  (*{{ secrets.hosts.pacsman | default("███") }}*)
- [ ] Mount a remote filesystem through sshfs:

    ``` bash
    sshfs {{ secrets.hosts.oesteban | default("<hostname>") }}:{{ settings.paths.pilot_sourcedata }} \
                   $HOME/data/hcph-pilot \
          {{ secrets.data.scp_args | default("<args>") }}
    ```

- [ ] Edit the query file `vim $HOME/queries/last-session.csv` (most likely, just update with the session's date)

    ``` text title="mydata-onesession.csv"
{% filter indent(width=4) %}
{% include 'code/pacsman/mydata-onesession.csv' %}
{% endfilter %}
    ```

- [ ] Prepare and run PACSMAN, pointing the output to the mounted directory.

    ``` bash
    pacsman --save -q $HOME/queries/last-session.csv \
           --out_directory $HOME/data/hcph-pilot/ \
           --config /opt/PACSMAN/files/config.json
    ```

- [ ] Unmount the remote filesystem:

    ``` bash
    sudo umount $HOME/data/hcph-pilot
    ```

### Retrieve physiological recordings

- [ ] Check that the *AcqKnowledge* file(s) corresponding to the session were added to the *Dropbox* shared folder and completely uploaded from {{ secrets.hosts.acqknowledge | default("████") }}.
- [ ] Check that *Psychopy*'s logs and ET's `.EDF` files corresponding to the session were added to the *Dropbox* shared folder and completely uploaded from {{ secrets.hosts.psychopy | default("████") }}.

## Within two weeks after the completed session

### Convert imaging data to BIDS with *HeuDiConv*

We use *HeuDiConv* to convert from the DICOM format generated by the scanner.
In addition, starting from the piloting session five, we abide by *ReproIn conventions*.
To support backward compatibility (and some extra, currently unsupported features by the original heuristic file), we have our own heuristic file.

??? info "Our custom heuristic file"

    Our heuristic file largely derives from [*ReproIn*'s at the time of writing](https://github.com/nipy/heudiconv/blob/55524168b02519bbf0a3a1c94cafb29a419728a0/heudiconv/heuristics/reproin.py).
    The heuristic has a a `#!python protocols2fix: dict[str | re.Pattern[str], list[tuple[str, str]]]` ([lines 113-148](#__codelineno-6-113)), where replacement patterns to permit backward compatibility are written.

    ``` {.python linenums="1" hl_lines="113-148"}
{% filter indent(width=4) %}
{% include 'code/heudiconv/reproin.py' %}
{% endfilter %}
    ```

!!! warning "During piloting, we changed a number of settings"

    For example, the first four sessions did not follow *Reproin* conventions and filenames
    varied substantially.
    Please note the `protocols2fix` variable in our heuristic file, where the compatibility is implemented.

- [ ] Run *HeuDiConv* with our heuristic file `{{ secrets.data.sops_clone_path | default('<path>') }}/code/heudiconv/reproin.py`:

    ``` bash title="Executing HeuDiConv"
{% filter indent(width=4) %}
{% include 'code/heudiconv/heudiconv_example.sh' %}
{% endfilter %}
    ```

    !!! warning "Session number MUST be updated manually"

    ??? important "Example of the dataset organization"

        Piloting sessions 15 and 16 look like this:

        ``` text
{% filter indent(width=8) %}
{% include 'code/bids/example01.txt' %}
{% endfilter %}
        ```

    ??? warning "We started to generate phase and magnitude only after session 15"

        As a result, the piloting data up to session 14 will look more like:

        ``` text
{% filter indent(width=8) %}
{% include 'code/bids/example02.txt' %}
{% endfilter %}
        ```

### Clean-up after BIDS conversion and preparation for archival

- [ ] Delete incorrect files generated by *HeuDiConv*:

    ``` bash
    find sub-001/ -name "*_part-mag_events.tsv" -or -name "*_part-phase_events.tsv" | xargs rm
    ```

- [ ] Compact DICOM session folder and remove it if successful

    ``` bash
    tar vczf ses-{{ secrets.ids.pacs_session | default("18950702") }}.tar.gz \
             {{ settings.paths.sourcedata }}/\
             sub-{{ secrets.ids.pacs_subject | default("01") }}/\
             ses-{{ secrets.ids.pacs_session | default("18950702") }} \
    && \
    rm -rf {{ settings.paths.sourcedata }}/\
           sub-{{ secrets.ids.pacs_subject | default("01") }}/\
           ses-{{ secrets.ids.pacs_session | default("18950702") }}
    ```

- [ ] Remove write permissions on the newly downloaded data:

    ``` bash
    chmod -R a-w {{ settings.paths.sourcedata }}/sub-{{ secrets.ids.pacs_subject | default("01") }}/
    ```

### Generate BIDS' *events* files

- [ ] Execute conversion with `code/events/psychopy2events`:

    ``` shell
    python psychopy2events.py --path ./outputdir/sub-001/ses-pilot016/func/
    ```

??? abstract "Example of a session with *events* files"

    The corresponding *events* files are highlighted below:

    ``` {.shell hl_lines="42-43 66-67 90-91"}
    ses-024
    ├── anat
    ├── dwi
    │   ├── sub-001_ses-024_acq-highres_dir-AP_dwi.bval
    │   ├── sub-001_ses-024_acq-highres_dir-AP_dwi.bvec
    │   ├── sub-001_ses-024_acq-highres_dir-AP_dwi.json
    │   ├── sub-001_ses-024_acq-highres_dir-AP_dwi.nii.gz
    │   ├── sub-001_ses-024_acq-highres_dir-AP_recording-cardiac_physio.json
    │   ├── sub-001_ses-024_acq-highres_dir-AP_recording-cardiac_physio.tsv.gz
    │   ├── sub-001_ses-024_acq-highres_dir-AP_recording-respiratory_physio.json
    │   ├── sub-001_ses-024_acq-highres_dir-AP_recording-respiratory_physio.tsv.gz
    │   ├── sub-001_ses-024_acq-highres_dir-AP_stim.json
    │   └── sub-001_ses-024_acq-highres_dir-AP_stim.tsv.gz
    ├── fmap
    ├── func
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-1_part-mag_bold.json
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-1_part-mag_bold.nii.gz
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-1_part-phase_bold.json
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-1_part-phase_bold.nii.gz
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-2_part-mag_bold.json
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-2_part-mag_bold.nii.gz
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-2_part-phase_bold.json
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-2_part-phase_bold.nii.gz
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-3_part-mag_bold.json
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-3_part-mag_bold.nii.gz
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-3_part-phase_bold.json
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-3_part-phase_bold.nii.gz
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-4_part-mag_bold.json
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-4_part-mag_bold.nii.gz
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-4_part-phase_bold.json
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-4_part-phase_bold.nii.gz
    │   ├── sub-001_ses-024_acq-highres_dir-AP_dwi.bval
    │   ├── sub-001_ses-024_acq-highres_dir-AP_dwi.bvec
    │   ├── sub-001_ses-024_acq-highres_dir-AP_dwi.json
    │   ├── sub-001_ses-024_acq-highres_dir-AP_dwi.nii.gz
    │   ├── sub-001_ses-024_acq-highres_dir-AP_recording-cardiac_physio.json
    │   ├── sub-001_ses-024_acq-highres_dir-AP_recording-cardiac_physio.tsv.gz
    │   ├── sub-001_ses-024_acq-highres_dir-AP_recording-respiratory_physio.json
    │   ├── sub-001_ses-024_acq-highres_dir-AP_recording-respiratory_physio.tsv.gz
    │   ├── sub-001_ses-024_acq-highres_dir-AP_stim.json
    │   └── sub-001_ses-024_acq-highres_dir-AP_stim.tsv.gz
    │   ├── sub-001_ses-024_task-bht_dir-AP_events.tsv
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-1_part-mag_bold.json
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-1_part-mag_bold.nii.gz
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-1_part-phase_bold.json
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-1_part-phase_bold.nii.gz
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-2_part-mag_bold.json
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-2_part-mag_bold.nii.gz
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-2_part-phase_bold.json
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-2_part-phase_bold.nii.gz
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-3_part-mag_bold.json
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-3_part-mag_bold.nii.gz
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-3_part-phase_bold.json
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-3_part-phase_bold.nii.gz
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-4_part-mag_bold.json
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-4_part-mag_bold.nii.gz
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-4_part-phase_bold.json
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-4_part-phase_bold.nii.gz
    │   ├── sub-001_ses-024_task-qct_dir-AP_recording-cardiac_physio.json
    │   ├── sub-001_ses-024_task-qct_dir-AP_recording-cardiac_physio.tsv.gz
    │   ├── sub-001_ses-024_task-qct_dir-AP_recording-respiratory_physio.json
    │   ├── sub-001_ses-024_task-qct_dir-AP_recording-respiratory_physio.tsv.gz
    │   ├── sub-001_ses-024_task-qct_dir-AP_stim.json
    │   ├── sub-001_ses-024_task-qct_dir-AP_stim.tsv.gz
    │   ├── sub-001_ses-024_task-qct_dir-AP_events.tsv
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-1_part-mag_bold.json
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-1_part-mag_bold.nii.gz
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-1_part-phase_bold.json
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-1_part-phase_bold.nii.gz
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-2_part-mag_bold.json
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-2_part-mag_bold.nii.gz
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-2_part-phase_bold.json
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-2_part-phase_bold.nii.gz
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-3_part-mag_bold.json
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-3_part-mag_bold.nii.gz
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-3_part-phase_bold.json
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-3_part-phase_bold.nii.gz
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-4_part-mag_bold.json
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-4_part-mag_bold.nii.gz
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-4_part-phase_bold.json
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-4_part-phase_bold.nii.gz
    │   ├── sub-001_ses-024_task-rest_dir-AP_recording-cardiac_physio.json
    │   ├── sub-001_ses-024_task-rest_dir-AP_recording-cardiac_physio.tsv.gz
    │   ├── sub-001_ses-024_task-rest_dir-AP_recording-respiratory_physio.json
    │   ├── sub-001_ses-024_task-rest_dir-AP_recording-respiratory_physio.tsv.gz
    │   ├── sub-001_ses-024_task-rest_dir-AP_stim.json
    │   └── sub-001_ses-024_task-rest_dir-AP_stim.tsv.gz
    │   └── sub-001_ses-024_task-rest_dir-AP_events.tsv
    └── sub-001_ses-024_scans.tsv
    ```

### Convert physiological recordings into BIDS (in-house)

- [ ] Install the necessary packages.
    ```
    python -m pip install bioread pandas matplotlib numpy pathlib scipy
    ```

- [ ] Update the appropriate session number within cell 3 in [the conversion *Jupyter* notebook](physio-to-bids.ipynb).
- [ ] Execute the notebook.

??? abstract "Example of a session with physiological recordings"

    The execution of the notebook on session 24 yields the following new outputs (highlighted):

    ``` {.shell hl_lines="8-13 32-37 54-59 76-81"}
    ses-024
    ├── anat
    ├── dwi
    │   ├── sub-001_ses-024_acq-highres_dir-AP_dwi.bval
    │   ├── sub-001_ses-024_acq-highres_dir-AP_dwi.bvec
    │   ├── sub-001_ses-024_acq-highres_dir-AP_dwi.json
    │   ├── sub-001_ses-024_acq-highres_dir-AP_dwi.nii.gz
    │   ├── sub-001_ses-024_acq-highres_dir-AP_recording-cardiac_physio.json
    │   ├── sub-001_ses-024_acq-highres_dir-AP_recording-cardiac_physio.tsv.gz
    │   ├── sub-001_ses-024_acq-highres_dir-AP_recording-respiratory_physio.json
    │   ├── sub-001_ses-024_acq-highres_dir-AP_recording-respiratory_physio.tsv.gz
    │   ├── sub-001_ses-024_acq-highres_dir-AP_stim.json
    │   └── sub-001_ses-024_acq-highres_dir-AP_stim.tsv.gz
    ├── fmap
    ├── func
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-1_part-mag_bold.json
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-1_part-mag_bold.nii.gz
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-1_part-phase_bold.json
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-1_part-phase_bold.nii.gz
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-2_part-mag_bold.json
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-2_part-mag_bold.nii.gz
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-2_part-phase_bold.json
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-2_part-phase_bold.nii.gz
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-3_part-mag_bold.json
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-3_part-mag_bold.nii.gz
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-3_part-phase_bold.json
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-3_part-phase_bold.nii.gz
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-4_part-mag_bold.json
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-4_part-mag_bold.nii.gz
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-4_part-phase_bold.json
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-4_part-phase_bold.nii.gz
    │   ├── sub-001_ses-024_task-bht_dir-AP_recording-cardiac_physio.json
    │   ├── sub-001_ses-024_task-bht_dir-AP_recording-cardiac_physio.tsv.gz
    │   ├── sub-001_ses-024_task-bht_dir-AP_recording-respiratory_physio.json
    │   ├── sub-001_ses-024_task-bht_dir-AP_recording-respiratory_physio.tsv.gz
    │   ├── sub-001_ses-024_task-bht_dir-AP_stim.json
    │   ├── sub-001_ses-024_task-bht_dir-AP_stim.tsv.gz
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-1_part-mag_bold.json
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-1_part-mag_bold.nii.gz
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-1_part-phase_bold.json
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-1_part-phase_bold.nii.gz
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-2_part-mag_bold.json
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-2_part-mag_bold.nii.gz
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-2_part-phase_bold.json
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-2_part-phase_bold.nii.gz
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-3_part-mag_bold.json
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-3_part-mag_bold.nii.gz
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-3_part-phase_bold.json
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-3_part-phase_bold.nii.gz
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-4_part-mag_bold.json
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-4_part-mag_bold.nii.gz
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-4_part-phase_bold.json
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-4_part-phase_bold.nii.gz
    │   ├── sub-001_ses-024_task-qct_dir-AP_recording-cardiac_physio.json
    │   ├── sub-001_ses-024_task-qct_dir-AP_recording-cardiac_physio.tsv.gz
    │   ├── sub-001_ses-024_task-qct_dir-AP_recording-respiratory_physio.json
    │   ├── sub-001_ses-024_task-qct_dir-AP_recording-respiratory_physio.tsv.gz
    │   ├── sub-001_ses-024_task-qct_dir-AP_stim.json
    │   ├── sub-001_ses-024_task-qct_dir-AP_stim.tsv.gz
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-1_part-mag_bold.json
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-1_part-mag_bold.nii.gz
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-1_part-phase_bold.json
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-1_part-phase_bold.nii.gz
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-2_part-mag_bold.json
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-2_part-mag_bold.nii.gz
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-2_part-phase_bold.json
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-2_part-phase_bold.nii.gz
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-3_part-mag_bold.json
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-3_part-mag_bold.nii.gz
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-3_part-phase_bold.json
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-3_part-phase_bold.nii.gz
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-4_part-mag_bold.json
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-4_part-mag_bold.nii.gz
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-4_part-phase_bold.json
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-4_part-phase_bold.nii.gz
    │   ├── sub-001_ses-024_task-rest_dir-AP_recording-cardiac_physio.json
    │   ├── sub-001_ses-024_task-rest_dir-AP_recording-cardiac_physio.tsv.gz
    │   ├── sub-001_ses-024_task-rest_dir-AP_recording-respiratory_physio.json
    │   ├── sub-001_ses-024_task-rest_dir-AP_recording-respiratory_physio.tsv.gz
    │   ├── sub-001_ses-024_task-rest_dir-AP_stim.json
    │   └── sub-001_ses-024_task-rest_dir-AP_stim.tsv.gz
    └── sub-001_ses-024_scans.tsv
    ```

### Convert eye-tracking into BIDS (in-house)

!!! warning "Instead of the current specifications, we are using [the following BEP](https://bids-specification--1128.org.readthedocs.build/en/1128/modality-specific-files/eye-tracking.html)"

- [ ] Check that *PyEDFRead* is installed as described in [the software annex](../data-collection/notes-software.md#conversion-of-et-recordings-into-bids).
- [ ] Employ our *in-house* conversion code, whose functioning is described in [our EDF to BIDS conversion how-to](edf-to-bids.md).

??? abstract "Example of a session with eye-tracking recordings"

    The files corresponding to eye-tracking are highlighted below:

    ``` {.shell hl_lines="22-23 40-41 58-59"}
    ses-024
    ├── anat
    ├── dwi
    ├── fmap
    ├── func
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-1_part-mag_bold.json
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-1_part-mag_bold.nii.gz
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-1_part-phase_bold.json
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-1_part-phase_bold.nii.gz
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-2_part-mag_bold.json
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-2_part-mag_bold.nii.gz
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-2_part-phase_bold.json
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-2_part-phase_bold.nii.gz
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-3_part-mag_bold.json
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-3_part-mag_bold.nii.gz
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-3_part-phase_bold.json
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-3_part-phase_bold.nii.gz
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-4_part-mag_bold.json
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-4_part-mag_bold.nii.gz
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-4_part-phase_bold.json
    │   ├── sub-001_ses-024_task-bht_dir-AP_echo-4_part-phase_bold.nii.gz
    │   ├── sub-001_ses-024_task-bht_dir-AP_eyetrack.json
    │   ├── sub-001_ses-024_task-bht_dir-AP_eyetrack.tsv.gz
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-1_part-mag_bold.json
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-1_part-mag_bold.nii.gz
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-1_part-phase_bold.json
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-1_part-phase_bold.nii.gz
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-2_part-mag_bold.json
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-2_part-mag_bold.nii.gz
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-2_part-phase_bold.json
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-2_part-phase_bold.nii.gz
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-3_part-mag_bold.json
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-3_part-mag_bold.nii.gz
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-3_part-phase_bold.json
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-3_part-phase_bold.nii.gz
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-4_part-mag_bold.json
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-4_part-mag_bold.nii.gz
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-4_part-phase_bold.json
    │   ├── sub-001_ses-024_task-qct_dir-AP_echo-4_part-phase_bold.nii.gz
    │   ├── sub-001_ses-024_task-qct_dir-AP_eyetrack.json
    │   ├── sub-001_ses-024_task-qct_dir-AP_eyetrack.tsv.gz
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-1_part-mag_bold.json
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-1_part-mag_bold.nii.gz
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-1_part-phase_bold.json
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-1_part-phase_bold.nii.gz
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-2_part-mag_bold.json
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-2_part-mag_bold.nii.gz
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-2_part-phase_bold.json
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-2_part-phase_bold.nii.gz
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-3_part-mag_bold.json
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-3_part-mag_bold.nii.gz
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-3_part-phase_bold.json
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-3_part-phase_bold.nii.gz
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-4_part-mag_bold.json
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-4_part-mag_bold.nii.gz
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-4_part-phase_bold.json
    │   ├── sub-001_ses-024_task-rest_dir-AP_echo-4_part-phase_bold.nii.gz
    │   ├── sub-001_ses-024_task-rest_dir-AP_eyetrack.json
    │   └── sub-001_ses-024_task-rest_dir-AP_eyetrack.tsv.gz
    └── sub-001_ses-024_scans.tsv
    ```

### Add new data to the *DataLad* dataset

As new sessions are collected, the corresponding BIDS structures MUST be saved within the *DataLad* dataset and pushed to remote storage systems:

- [ ] Save the files in the dataset history using the command below.
    Replace `<session_id>` below with the number of the session (e.g., `pilot017`):

    ``` shell
    datalad save -r -m "add: session <session_id>" sub-001/ses-<session_id>
    ```

    !!! danger "Always double-check that data are annexed and the metadata committed to git"

        Although the [creation of a procedure](preliminary.md#creating-a-datalad-dataset) should ensure data and metadata are added to the appropriate version control (Git or Git-Annex), it is possible that some metadata or data formats are not anticipated, or do not follow the general rules.

        A generally good strategy is to avoid recursion (i.e., do not use the `-r` flag), and leverage Bash's `find` and `xargs` tools.
        For example, the following command line selects metadata files that should be committed to Git within one session (`pilot020`) and saves them:

        ``` shell
        find sub-001/ses-pilot020 -name "*.tsv" -or -name "*.json" -or -name "*.bvec" -or -name "*.bval" | xargs datalad save --to-git -m '"add(pilot020): new session metadata"'
        ```

        Correspondingly, we can store NIfTI data and physiological information:

        ``` shell
        find sub-001/ses-pilot020 -name "*.nii.gz" -or -name "*_eyetrack.tsv.gz" -or -name "*_physio.tsv.gz" -or -name "*_stim.tsv.gz" | xargs datalad save -m '"add(pilot020): new session NIfTI data, eye tracking and physio"'
        ```

        Please read [*DataLad*'s `save` documentation](http://docs.datalad.org/en/stable/generated/man/datalad-save.html)

    !!! important "If you overeagerly *datalad-saved* too many files"

        You can [*revert* the `datalad save` operation](https://handbook.datalad.org/en/latest/basics/101-137-history.html) without deleting changes with:

        ``` shell
        git reset --mixed COMMIT
        ```

        where `COMMIT` is the hash of the last commit you want to keep (all the later commits will be dropped).

        To check the commit hash where you can roll history back to, you may want to use:

        ``` shell
        git log -50 --oneline
        ```

    !!! tip "Saving batches of sessions"

        It is possible to save several sessions with the following *Bash* script by enumerating them in the array defined in the first line here:

        ``` shell
        SESSIONS=( 001 003 pilot21 ); \
        for SESSION in ${SESSIONS[@]}; do \
            find sub-001/ses-$SESSION -name "*.tsv" -or -name "*.json" -or -name "*.bvec" -or -name "*.bval" | xargs datalad save --to-git -m '"add('"$SESSION"'): new session metadata"'; \
            find sub-001/ses-$SESSION -name "*.nii.gz" -or -name "*_eyetrack.tsv.gz" -or -name "*_physio.tsv.gz" -or -name "*_stim.tsv.gz" | xargs datalad save -m '"add('"$SESSION"'): new session NIfTI data, eye tracking and physio"'; \
        done
        ```

- [ ] Push the new data to the remote storage (if your git containing *DataLad* and the Git annex is different from `origin`, e.g., `github`, replace the name below):

    ``` shell
    datalad push --to ria-storage
    datalad push --to origin
    ```

    !!! danger "Always double-check that data in the annex are uploaded to the RIA store"

### Formal QC

- [ ] Consult the [session logs](../data-collection/tear-up.md#start-a-new-session-log-form) to anticipate session peculiarities (e.g the session was aborted prematurely) and potential quality issues (e.g the participan fell asleep).
    Those are saved in [the issues of our repository](https://github.com/TheAxonLab/hcph-sops/issues) with the label <span class="consolebutton brown">scan</span>.
    Keep note of the peculiar events, associated with their session index, and keep it close to you during quality control.

- [ ] Run the *BIDS Validator* to check the *formal* quality of the dataset (filenames, homogeneity of modalities and parameters across sessions, etc.)

    ``` shell

    docker run -ti --rm -v {{ secrets.celine_paths.data_sherlock | default('/path/to/data/') }}/hcph/:/data:ro bids/validator /data
    ```

??? bug "BIDS non-compliance: WARNINGS and ERRORS"

    We do not fully comply with current BIDS specifications, so some ERRORS and WARNINGS will emerge.
    If errors and warnings are not listed here, please reach out to decide on a solution.

    1. **ERRORS**: Because we follow [BEP 020](https://bids-specification--1128.org.readthedocs.build/en/1128/modality-specific-files/eye-tracking.html) and it is not official yet, ET-related files will source ERRORS:

        ```
        [ERR] Files with such naming scheme are not part of BIDS specification.
        ```

    2. **WARNINGS**: some warnings are expected.
        Warnings that are not among this list should be addressed and BIDS conversion should be re-run on the affected files:

        - During the piloting phase of the study, we tried out different sequence parameters and sequence type. As such, the following warning is expected:

            ```
            [WARN] Not all subjects/sessions/runs have the same scanning parameters. (code: 39 - INCONSISTENT_PARAMETERS)
            ```

        - The `_magnitude{1,2}.nii.gz` files corresponding to some pilot sessions are missing:

            ```
            [WARN] Each _phasediff.nii[.gz] file should be associated with a _magnitude1.nii[.gz] file. (code: 92 MISSING_MAGNITUDE1_FILE)
            ./sub-001/ses-pilot001/fmap/sub-001_ses-pilot001_phasediff.nii.gz
            ./sub-001/ses-pilot004/fmap/sub-001_ses-pilot004_phasediff.nii.gz
            ./sub-001/ses-pilot006/fmap/sub-001_ses-pilot006_phasediff.nii.gz
            ```

### Visual assessment of unprocessed data with *MRIQC*

Checking the data quality shortly after they are acquired increases the likelihood of catching systematic artifacts early enough to avert spreading throughout the whole dataset.
It also modulates the burden of visual inspection over time, such that we avoid overwhelming raters with outbursts of images to assess.
Better pacing in rating throughput also contributes to reducing raters' attrition and fatigue.

- [ ] Screen all the unprocessed data and assess them as described in the [next section](./mriqc.md).

## Upon updates and bugfixes of the dataset

### Update *PyBIDS*'s database index

??? tip "The *PyBIDS* index cache dramatically speeds up *MRIQC*, *fMRIPrep* and *dMRIPrep*"

    To speed up the tear-up time of *NiPreps* tools (*MRIQC*, *fMRIPrep*, and *dMRIPrep*) and other relevant code using *PyBIDS*, we have added a database cache under the `{{ settings.paths.hcph_bids }}/.bids-index/` folder.
    This cache can be leverage by adding the `--bids-database-dir {{ settings.paths.hcph_bids }}/.bids-index/` to the corresponding command line.

- [ ] Unlock the database file to enable update:

    ``` shell
    cd {{ settings.paths.hcph_bids }}
    datalad unlock .bids-index/layout_index.sqlite
    ```

- [ ] Reset the database file:

    ``` shell
    python -m pip install "pybids>=0.16"
    $( dirname $( which python ) )/pybids layout --reset-db --no-validate --index-metadata . .bids-index/
    ```

    Successful execution will finalize with a message: `Successfully generated database index at {{ settings.paths.hcph_bids }}/.bids-index`.

- [ ] Save the dataset again:

    ``` shell
    datalad save -m "enh: updated PyBIDS' database file" {{ settings.paths.hcph_bids }}/.bids-index
    ```

- [ ] Push the changes back to the repos:

    ``` shell
    datalad push --to=github
    ```
